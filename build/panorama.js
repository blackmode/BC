function loadJSONfile(){if(null==CACHE.json_object){var a=getCurrentProgramFilename().split(".")[0],b=a+".json",c=new XMLHttpRequest;if(c.open("GET",b,!1),c.send(null),200!=c.status||"OK"!==c.statusText)return w("nepogedlo se nacist soubor JSON!"),!1;var d=JSON.parse(c.responseText);CACHE.json_object=d}else var d=CACHE.json_object;var e=!1,f=!1;if(d.fisheye)if(d.fisheye.video&&SETTINGS.mode.fisheye.video.active){var g=getParamByKey("fishVM_json_key")?getParamByKey("fishVM_json_key"):0,h=d.fisheye.video[g];if(!h||!h.src)return w("nepodarilo se nacist data ze souboru JSON"),!1;e=h.src,h.compass&&(null==h.compass.north||isNaN(h.compass.north)||h.compass.north==SETTINGS.compass.north||(SETTINGS.compass.north=h.compass.north,log("Compass: uspesne prenastaveno")))}else if(d.fisheye.panorama&&SETTINGS.mode.fisheye.panorama.active){var g=getParamByKey("fishPM_json_key")?getParamByKey("fishPM_json_key"):0,i=d.fisheye.panorama[g];if(!i||!i.src)return w("nepodarilo se nacist data ze souboru JSON"),!1;f=i.src,i.compass&&(null==i.compass.north||isNaN(i.compass.north)||i.compass.north==SETTINGS.compass.north||(SETTINGS.compass.north=i.compass.north,log("Compass: uspesne prenastaveno")))}if(d.equirectangular)if(d.equirectangular.video&&SETTINGS.mode.equirectangular.video.active){var g=getParamByKey("equiVM_json_key")?getParamByKey("equiVM_json_key"):0,j=d.equirectangular.video[g];if(!j||!j.src)return w("nepodarilo se nacist data ze souboru JSON"),!1;e=j.src,j.compass&&(null==j.compass.north||isNaN(j.compass.north)||j.compass.north==SETTINGS.compass.north||(SETTINGS.compass.north=j.compass.north,log("Compass: uspesne prenastaveno")))}else if(d.equirectangular.panorama&&SETTINGS.mode.equirectangular.panorama.active){var g=getParamByKey("equiPM_json_key")?getParamByKey("equiPM_json_key"):0,k=d.equirectangular.panorama[g];if(!k||!k.src)return w("nepodarilo se nacist data ze souboru JSON"),!1;f=k.src,k.compass&&(null==k.compass.north||isNaN(k.compass.north)||k.compass.north==SETTINGS.compass.north||(SETTINGS.compass.north=k.compass.north,log("Compass: uspesne prenastaveno")))}return{video:e,image:f}}function updateObjectVariables(){SETTINGS.compass.object=createCompass(SETTINGS.compass.width,SETTINGS.compass.height,SETTINGS.compass.canvas_position_x,SETTINGS.compass.canvas_position_y,SETTINGS.compass.north,SETTINGS.compass.angle),SETTINGS.field_vision.object=createFieldVision(SETTINGS.field_vision.width,SETTINGS.field_vision.height,SETTINGS.field_vision.canvas_position_x,SETTINGS.field_vision.canvas_position_y,SETTINGS.field_vision.angle,SETTINGS.field_vision.shift),SETTINGS.video_controlls.object=createVideoControlls(SETTINGS.video_controlls.width,SETTINGS.video_controlls.height,SETTINGS.video_controlls.canvas_position_x,SETTINGS.video_controlls.canvas_position_y),SETTINGS.panorama_controlls.object=createPanoramaControlls(SETTINGS.panorama_controlls.width,SETTINGS.panorama_controlls.height,SETTINGS.panorama_controlls.canvas_position_x,SETTINGS.panorama_controlls.canvas_position_y),SETTINGS.video_status_bar.object=createVideoStatusBar(SETTINGS.video_status_bar.width,SETTINGS.video_status_bar.height,SETTINGS.video_status_bar.canvas_position_x,SETTINGS.video_status_bar.canvas_position_y,SETTINGS.input.video),settings_window(SETTINGS.panorama_controlls.btn.settings.show_window),subtitles_window(SETTINGS.panorama_controlls.subtitles_box.active,"")}function initProgram(){var a=null;if(SETTINGS.mode.equirectangular.panorama.active||SETTINGS.mode.equirectangular.video.active?a=0:(SETTINGS.mode.fisheye.panorama.active||SETTINGS.mode.fisheye.video.active)&&(a=1),PROG.canvas=document.querySelector("canvas"),!(gl=PROG.canvas.getContext("webgl")||PROG.canvas.getContext("experimental-webgl"))){var b="Webgl se nepodařilo inicializovat. Není podporováno. ";return e(b),createInfoScreen(b,SETTINGS.info_screen.width,SETTINGS.info_screen.height),!1}if((SETTINGS.mode.equirectangular.video.active||SETTINGS.mode.fisheye.video.active)&&!SETTINGS.input.video){var b="Video se nepodařilo načíst!";return e(b),createInfoScreen(b,SETTINGS.info_screen.width,SETTINGS.info_screen.height),!1}if((SETTINGS.mode.equirectangular.panorama.active||SETTINGS.mode.fisheye.panorama.active)&&!SETTINGS.input.image){var b="Panorama se nepdařilo načíst!";return e(b),createInfoScreen(b,SETTINGS.info_screen.width,SETTINGS.info_screen.height),!1}return SETTINGS.default.canvas.width=PROG.canvas.width,SETTINGS.default.canvas.height=PROG.canvas.height,GEOMETRY=createSphereGeometry(SETTINGS.mode.fisheye.video.latitudes,SETTINGS.mode.fisheye.video.longtitudes,SETTINGS.mode.fisheye.video.radius,a),PROG.matrices.model.data=createIdentityMatrix4(),PROG.matrices.view.data=createIdentityMatrix4(),PROG.matrices.projection.data=createIdentityMatrix4(),PROG.matrices.projection.fov=Math.PI/1.75,SETTINGS.field_vision.angle=1.2*radToDeg(PROG.matrices.projection.fov),SETTINGS.video_controlls.width=PROG.canvas.width/2,PROG.startTime=(new Date).getTime(),loadJSONfile(),updateObjectVariables(),!0}function settings_window(a){SETTINGS.panorama_controlls.btn.settings.show_window=a,SETTINGS.panorama_controlls.btn.settings.object=createWindowSettings(SETTINGS.panorama_controlls.btn.settings.width,SETTINGS.panorama_controlls.btn.settings.height,SETTINGS.panorama_controlls.btn.settings.canvas_position_x,SETTINGS.panorama_controlls.btn.settings.canvas_position_y,SETTINGS.panorama_controlls.btn.settings.show_window)}function subtitles_window(a,b){SETTINGS.panorama_controlls.subtitles_box.active=a,SETTINGS.panorama_controlls.subtitles_box.object=createSubtitlesBox(SETTINGS.panorama_controlls.subtitles_box.width,SETTINGS.panorama_controlls.subtitles_box.height,SETTINGS.panorama_controlls.subtitles_box.canvas_position_x,SETTINGS.panorama_controlls.subtitles_box.canvas_position_y,SETTINGS.panorama_controlls.subtitles_box.active,b)}function setupProgram(){if(!initProgram())return e("FATALNI CHYBA, nepodarilo se inicializovat program"),createLoader(150,150,.5,.5,1,1258),createInfoScreen("FATALNI CHYBA, nepodarilo se inicializovat program",SETTINGS.info_screen.width,SETTINGS.info_screen.height),!1;PROG.canvas.addEventListener("mousemove",onDocumentMouseMove,!1),PROG.canvas.addEventListener("mousedown",onDocumentMouseDown,!1),PROG.canvas.addEventListener("mouseup",onDocumentMouseUp,!1),PROG.canvas.addEventListener("touchmove",onDocumentMouseMove,!1),PROG.canvas.addEventListener("touchstart",onDocumentMouseDown,!1),PROG.canvas.addEventListener("touchend",onDocumentMouseUp,!1),document.addEventListener("mouseout",onDocumentMouseOut,!1);for(var a=["mousemove","mousedown","mouseup","touchmove","touchstart","touchend"],b=[onDocumentMouseMove,onDocumentMouseDown,onDocumentMouseUp,onDocumentMouseMove,onDocumentMouseDown,onDocumentMouseUp],c=0;c<a.length;c++)SETTINGS.compass.object.addEventListener(a[c],b[c],!1),SETTINGS.field_vision.object.addEventListener(a[c],b[c],!1),SETTINGS.panorama_controlls.object.controlls.addEventListener(a[c],b[c],!1),SETTINGS.panorama_controlls.btn.settings.object.settings.addEventListener(a[c],b[c],!1);(SETTINGS.mode.equirectangular.video.active||SETTINGS.mode.fisheye.video.active)&&(SETTINGS.video_controlls.object.controlls.addEventListener("mouseover",onDocumentMouseOver,!1),SETTINGS.video_controlls.object.btn.play.addEventListener("click",function(){1==SETTINGS.input.video.paused?(SETTINGS.input.video.play(),SETTINGS.video_controlls.object.btn.play.setAttribute("class","pause_icon")):(SETTINGS.input.video.pause(),SETTINGS.video_controlls.object.btn.play.setAttribute("class","play_icon"))}),SETTINGS.input.video.addEventListener("timeupdate",function(){var a=100/SETTINGS.input.video.duration*SETTINGS.input.video.currentTime,b=SETTINGS.input.video.currentTime,c=0,d=0;if(SETTINGS.mode.equirectangular.video.active&&(c=getParamByKey("equiVM_json_key")?getParamByKey("equiVM_json_key"):0,d=CACHE.json_object.equirectangular.video[c]),SETTINGS.mode.fisheye.video.active&&(c=getParamByKey("fishVM_json_key")?getParamByKey("fishVM_json_key"):0,d=CACHE.json_object.fisheye.video[c]),SETTINGS.panorama_controlls.subtitles_box.active)for(var e=0;e<d.titles.length;e++){var f=d.titles[e];b>=f.time&&(subtitles_window(!0,f.text),SETTINGS.panorama_controlls.subtitles_box.current_subtitle=f.text)}for(var e=0;e<d.compass.correction.length;e++){var g=d.compass.correction[e];b>=g.time&&(SETTINGS.compass.north=g.angle,SETTINGS.compass.object=createCompass(SETTINGS.compass.width,SETTINGS.compass.height,SETTINGS.compass.canvas_position_x,SETTINGS.compass.canvas_position_y,SETTINGS.compass.north,SETTINGS.compass.angle))}SETTINGS.video_controlls.object.btn.slider.value=a,SETTINGS.video_status_bar.object.text.innerHTML="<div>"+Math.round(SETTINGS.input.video.currentTime/SETTINGS.input.video.duration*100)+" %</div>",SETTINGS.video_status_bar.object.box.setAttribute("value",""+SETTINGS.input.video.currentTime/SETTINGS.input.video.duration)}),SETTINGS.input.video.addEventListener("ended",function(){SETTINGS.video_controlls.object.btn.play.setAttribute("class","play_icon")}),SETTINGS.input.video.addEventListener("progress",function(){SETTINGS.input.video.buffered,this.currentTime}),SETTINGS.video_controlls.object.btn.slider.addEventListener("change",function(){var a=SETTINGS.video_controlls.object.btn.slider.value/100*SETTINGS.input.video.duration;SETTINGS.input.video.currentTime=a}),SETTINGS.video_controlls.object.btn.slider.addEventListener("mousedown",function(){SETTINGS.input.video.pause(),SETTINGS.video_controlls.object.btn.play.setAttribute("class","play_icon")}),SETTINGS.video_controlls.object.btn.slider.addEventListener("mouseup",function(){SETTINGS.input.video.play(),SETTINGS.video_controlls.object.btn.play.setAttribute("class","pause_icon")}),SETTINGS.video_controlls.object.btn.volume_slider.addEventListener("change",function(){SETTINGS.input.video.volume=SETTINGS.video_controlls.object.btn.volume_slider.value}),SETTINGS.video_controlls.object.btn.volume.addEventListener("click",function(){SETTINGS.input.video.muted?(SETTINGS.input.video.muted=!1,SETTINGS.video_controlls.object.btn.volume.setAttribute("class","volume_on_icon")):SETTINGS.input.video.muted||(SETTINGS.input.video.muted=!0,SETTINGS.video_controlls.object.btn.volume.setAttribute("class","volume_off_icon"))})),SETTINGS.panorama_controlls.object.btn.fullscreen.addEventListener("click",function(){"fullscreen_icon"==SETTINGS.panorama_controlls.object.btn.fullscreen.getAttribute("class")?(SETTINGS.panorama_controlls.object.btn.fullscreen.setAttribute("class","normalscreen_icon"),PROG.canvas.width=window.innerWidth,PROG.canvas.height=window.innerHeight,gl.viewport(0,0,PROG.canvas.width,PROG.canvas.height),resize()):"normalscreen_icon"==SETTINGS.panorama_controlls.object.btn.fullscreen.getAttribute("class")&&(SETTINGS.panorama_controlls.object.btn.fullscreen.setAttribute("class","fullscreen_icon"),PROG.canvas.width=SETTINGS.default.canvas.width,PROG.canvas.height=SETTINGS.default.canvas.height,gl.viewport(0,0,PROG.canvas.width,PROG.canvas.height),resize())}),SETTINGS.panorama_controlls.object.btn.zoom_plus.addEventListener("click",function(){zoom_plus()}),SETTINGS.panorama_controlls.object.btn.zoom_minus.addEventListener("click",function(){zoom_minus()}),SETTINGS.panorama_controlls.object.btn.settings.addEventListener("click",function(){settings_window(SETTINGS.panorama_controlls.btn.settings.show_window?0:1)}),SETTINGS.panorama_controlls.btn.settings.object.btn.subtit.addEventListener("click",function(){SETTINGS.panorama_controlls.subtitles_box.active?(subtitles_window(!1,SETTINGS.panorama_controlls.subtitles_box.current_subtitle),SETTINGS.panorama_controlls.btn.settings.object.btn.subtit.setAttribute("class","window_settings_btn_inactive")):(subtitles_window(!0,SETTINGS.panorama_controlls.subtitles_box.current_subtitle),SETTINGS.panorama_controlls.btn.settings.object.btn.subtit.setAttribute("class","window_settings_btn_active"))}),window.addEventListener("focus",playVideoWhenInactive),window.addEventListener("blur",pauseVideoWhenInactive);var d="mousewheel";/Firefox/i.test(navigator.userAgent)&&(d="DOMMouseScroll"),document.addEventListener(d,onDocumentMouseWheel,!1),document.addEventListener("keypress",onDocumentKeyPress,!1),window.addEventListener("resize",onWindowResize,!0);var f=document.querySelector("#vs").textContent,g=gl.createShader(gl.VERTEX_SHADER);if(gl.shaderSource(g,f),gl.compileShader(g),!gl.getShaderParameter(g,gl.COMPILE_STATUS))return w("nepodařilo se zkompilovat VERTEX_SHADER"),createInfoScreen("nepodařilo se zkompilovat VERTEX SHADER",SETTINGS.info_screen.width,SETTINGS.info_screen.height),!1;var f=document.querySelector("#fs").textContent,i=gl.createShader(gl.FRAGMENT_SHADER);if(gl.shaderSource(i,f),gl.compileShader(i),!gl.getShaderParameter(i,gl.COMPILE_STATUS))return w("nepodařilo se zkompilovat FRAGMENT_SHADER"),createInfoScreen("nepodařilo se zkompilovat FRAGMENT SHADER",SETTINGS.info_screen.width,SETTINGS.info_screen.height),createLoader(150,150,.5,.5,1,1258),!1;if(PROG.program=gl.createProgram(),gl.attachShader(PROG.program,g),gl.attachShader(PROG.program,i),gl.linkProgram(PROG.program),gl.useProgram(PROG.program),!gl.getProgramParameter(PROG.program,gl.LINK_STATUS)){var l=gl.getProgramInfoLog(PROG.program);return createLoader(150,150,.5,.5,1,1258),w("nepodařilo se zkompilovat WebGL PROG. \n\n"+l),createInfoScreen("nepodařilo se zkompilovat WebGL PROG",SETTINGS.info_screen.width,SETTINGS.info_screen.height),!1}if(scale(PROG.matrices.model.data,1,1,1),translate(PROG.matrices.model.data,0,0,0),SETTINGS.mode.equirectangular.panorama.active||SETTINGS.mode.equirectangular.video.active?(rotateZ(PROG.matrices.model.data,Math.PI/2),rotateX(PROG.matrices.model.data,1.5*Math.PI),rotateY(PROG.matrices.model.data,Math.PI)):(SETTINGS.mode.fisheye.panorama.active||SETTINGS.mode.fisheye.video.active)&&(rotateZ(PROG.matrices.model.data,Math.PI/2),rotateX(PROG.matrices.model.data,2*Math.PI),rotateY(PROG.matrices.model.data,2*Math.PI)),getParamByKey("angleX")&&rotateX(PROG.matrices.model.data,Math.PI*getParamByKey("angleX")),getParamByKey("angleZ")&&rotateZ(PROG.matrices.model.data,Math.PI*getParamByKey("angleZ")),getParamByKey("angleY")&&rotateY(PROG.matrices.model.data,Math.PI*getParamByKey("angleY")),getParamByKey("camera")&&translate(PROG.matrices.model.data,0,0,getParamByKey("camera")),PROG.matrices.projection.data=createPerspectiveMatrix(PROG.matrices.projection.fov,PROG.canvas.width/PROG.canvas.height,.1,100),PROG.matrices.model.link=gl.getUniformLocation(PROG.program,"M_Matrix"),gl.uniformMatrix4fv(PROG.matrices.model.link,!1,PROG.matrices.model.data),PROG.matrices.view.link=gl.getUniformLocation(PROG.program,"V_Matrix"),gl.uniformMatrix4fv(PROG.matrices.view.link,!1,PROG.matrices.model.data),PROG.matrices.projection.link=gl.getUniformLocation(PROG.program,"P_Matrix"),gl.uniformMatrix4fv(PROG.matrices.projection.link,!1,PROG.matrices.projection.data),PROG.sampler=gl.getUniformLocation(PROG.program,"sampler"),gl.uniform1i(PROG.sampler,0),PROG.attributes.vertex=gl.getAttribLocation(PROG.program,"pos"),-1===PROG.attributes.vertex&&w('Nebyl nalezen atribut "pos" ve vertex shaderu'),gl.enableVertexAttribArray(PROG.attributes.vertex),PROG.attributes.fragment=gl.getAttribLocation(PROG.program,"fragPos"),-1==PROG.attributes.fragment&&w('Nebyl nalezen atribut "fragPos" ve vertex shaderu'),gl.enableVertexAttribArray(PROG.attributes.fragment),PROG.attributes.texture=gl.getAttribLocation(PROG.program,"texture"),-1==PROG.attributes.texture&&w('Nebyl nalezen atribut "texture" ve vertex shaderu'),gl.enableVertexAttribArray(PROG.attributes.texture),PROG.buffer.vertex=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,PROG.buffer.vertex),gl.bufferData(gl.ARRAY_BUFFER,GEOMETRY.vertices,gl.STATIC_DRAW),gl.vertexAttribPointer(PROG.attributes.vertex,3,gl.FLOAT,!1,0,0),PROG.buffer.normal=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,PROG.buffer.normal),gl.bufferData(gl.ARRAY_BUFFER,GEOMETRY.normals,gl.STATIC_DRAW),gl.vertexAttribPointer(PROG.attributes.fragment,3,gl.FLOAT,!1,0,0),PROG.buffer.texture=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,PROG.buffer.texture),gl.bufferData(gl.ARRAY_BUFFER,GEOMETRY.textures,gl.STATIC_DRAW),gl.vertexAttribPointer(PROG.attributes.texture,2,gl.FLOAT,!1,0,0),PROG.buffer.index=gl.createBuffer(),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,PROG.buffer.index),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,GEOMETRY.indices,gl.STATIC_DRAW),gl.enable(gl.DEPTH_TEST),gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),PROG.texture=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,PROG.texture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.bindTexture(gl.TEXTURE_2D,null),SETTINGS.mode.equirectangular.panorama.active||SETTINGS.mode.fisheye.panorama.active){if(createLoader(150,150,.5,.5,1,1258),!imgLoaded)return w("obrazek se nepodarilo uspesne nacist"),!1;createLoader(150,150,.5,.5,0,1258),gl.bindTexture(gl.TEXTURE_2D,PROG.texture),SETTINGS.mode.equirectangular.panorama.active,gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,SETTINGS.input.image)}return!0}function updateTexture(){return!SETTINGS.mode.fisheye.video.active&&!SETTINGS.mode.equirectangular.video.active||(SETTINGS.input.video.readyState>=SETTINGS.input.video.HAVE_CURRENT_DATA?(gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,PROG.texture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGB,gl.RGB,gl.UNSIGNED_BYTE,SETTINGS.input.video),gl.bindTexture(gl.TEXTURE_2D,null),createLoader(150,150,.5,.5,0,1258),!0):SETTINGS.input.video.readyState<SETTINGS.input.video.HAVE_CURRENT_DATA?(console.log("video se nacita..."),createLoader(150,150,.5,.5,1,1258),!1):void 0)}function initViewMatrix(){makeIdentityFrom(PROG.matrices.view.data),translate(PROG.matrices.view.data,0,0,0)}function updateCameraPosition(){translate(PROG.matrices.view.data,0,0,MOUSE.wheel.delta),rotateY(PROG.matrices.view.data,MOUSE.move.angle.y),rotateX(PROG.matrices.view.data,MOUSE.move.angle.x)}function getCameraPosition(){return PROG.matrices.view.data[14]}function pauseVideoWhenInactive(){(SETTINGS.mode.fisheye.video.active||SETTINGS.mode.equirectangular.video.active)&&(0==SETTINGS.input.video.paused?(SETTINGS.video_controlls.user_inactive=!0,SETTINGS.input.video.pause(),SETTINGS.video_controlls.object.btn.play.setAttribute("class","play_icon")):SETTINGS.video_controlls.user_inactive=!1)}function playVideoWhenInactive(){(SETTINGS.mode.fisheye.video.active||SETTINGS.mode.equirectangular.video.active)&&1==SETTINGS.video_controlls.user_inactive&&1==SETTINGS.input.video.paused&&(SETTINGS.input.video.play(),SETTINGS.video_controlls.object.btn.play.setAttribute("class","pause_icon"),SETTINGS.video_controlls.user_inactive)}function render(a){if(SETTINGS.mode.fisheye.video.active||SETTINGS.mode.equirectangular.video.active){document.getElementById("data").innerHTML="Čas: "+SETTINGS.input.video.currentTime}var c=MOUSE.move.angle.y*(180/Math.PI)%360;if(SETTINGS.compass.angle=c,SETTINGS.compass.object=createCompass(SETTINGS.compass.width,SETTINGS.compass.height,SETTINGS.compass.canvas_position_x,SETTINGS.compass.canvas_position_y,SETTINGS.compass.north,SETTINGS.compass.angle),updateTexture()){initViewMatrix();if((new Date).getTime()<PROG.time+700&&MOUSE.amort>=1.001&&(MOUSE.amort=MOUSE.amort-.001),(SETTINGS.mode.equirectangular.panorama.active||SETTINGS.mode.fisheye.panorama.active)&&SETTINGS.panorama_controlls.subtitles_box.active){var e=0,f=0;SETTINGS.mode.equirectangular.panorama.active&&(e=getParamByKey("equiPM_json_key")?getParamByKey("equiPM_json_key"):0,f=CACHE.json_object.equirectangular.panorama[e]),SETTINGS.mode.fisheye.panorama.active&&(e=getParamByKey("fishPM_json_key")?getParamByKey("fishPM_json_key"):0,f=CACHE.json_object.fisheye.panorama[e]);for(var g=0;g<f.titles.length;g++){var h=f.titles[g],i=parseInt(((new Date).getTime()-PROG.startTime)/1e3);i>=h.time&&i<=h.time+h.duration&&(subtitles_window(!0,h.text),SETTINGS.panorama_controlls.subtitles_box.current_subtitle=h.text)}}updateCameraPosition(),gl.uniformMatrix4fv(PROG.matrices.projection.link,!1,PROG.matrices.projection.data),gl.uniformMatrix4fv(PROG.matrices.view.link,!1,PROG.matrices.view.data),gl.uniformMatrix4fv(PROG.matrices.model.link,!1,PROG.matrices.model.data),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,PROG.texture),gl.uniform1i(PROG.sampler,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),GEOMETRY.noIndices?(gl.bindBuffer(gl.ARRAY_BUFFER,PROG.buffer.vertex),gl.drawArrays(gl.TRIANGLES,0,GEOMETRY.normals.length/3)):(gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,PROG.buffer.index),gl.drawElements(gl.TRIANGLES,GEOMETRY.indices.length,gl.UNSIGNED_SHORT,0))}requestAnimationFrame(render)}function onDocumentMouseWheel(a){var b=0;a.wheelDeltaY?b+=a.wheelDeltaY:a.wheelDelta?b+=a.wheelDelta:a.detail&&(b+=-1*a.detail);var c=MOUSE.wheel.reduction>1?MOUSE.wheel.reduction:1;MOUSE.wheel.deltaMax=(SETTINGS.mode.fisheye.video.radius-2*MOUSE.wheel.sensitivity)/c,MOUSE.wheel.deltaMin=-MOUSE.wheel.deltaMax,b>0?zoom_plus():zoom_minus();var d=radToDeg(PROG.matrices.projection.fov),e=2*d,f=2*SETTINGS.mode.fisheye.video.radius,g=(f-f/MOUSE.wheel.reduction)/2,h=1-(MOUSE.wheel.delta+MOUSE.wheel.deltaMax)/(2*MOUSE.wheel.deltaMax);SETTINGS.field_vision.angle=g/10*e+e*h*(1-g/10),createFieldVision(SETTINGS.field_vision.width,SETTINGS.field_vision.height,SETTINGS.field_vision.canvas_position_x,SETTINGS.field_vision.canvas_position_y,SETTINGS.field_vision.angle,SETTINGS.field_vision.shift)}function onDocumentMouseOut(a){if(MOUSE.active&&!MOUSE.interrupt){checkEvent=a||window.event;var b=checkEvent.relatedTarget||checkEvent.toElement;"HTML"!=b.nodeName&&b||(MOUSE.active=!1,d("mys opustila okno"))}}function onDocumentMouseOver(a){MOUSE.active&&!MOUSE.interrupt&&(MOUSE.active=!1)}function onDocumentMouseUp(a){MOUSE.active=!1;var b=new Date;PROG.time=b.getTime(),MOUSE.amort=1.02}function onDocumentMouseDown(a){return"touchstart"==a.type&&(a.pageX=a.changedTouches[0].pageX,a.pageY=a.changedTouches[0].pageY),MOUSE.active=!0,MOUSE.down.x=a.pageX,MOUSE.down.y=a.pageY,a.preventDefault(),!1}function onDocumentMouseMove(a){if(MOUSE.active&&!MOUSE.interrupt){if("touchmove"==a.type&&(a.pageX=a.changedTouches[0].pageX,a.pageY=a.changedTouches[0].pageY),a.pageX>=PROG.canvas.width-10||a.pageY>=PROG.canvas.height-10)return MOUSE.active=!1,!1;MOUSE.move.x=2*(a.pageX-MOUSE.down.x)*Math.PI/PROG.canvas.width,MOUSE.move.y=2*(a.pageY-MOUSE.down.y)*Math.PI/PROG.canvas.height,MOUSE.move.angle.y+=MOUSE.move.x,MOUSE.move.angle.x+=MOUSE.move.y,MOUSE.move.angle.y=MOUSE.move.angle.y%(2*Math.PI),MOUSE.move.angle.x=MOUSE.move.angle.x%(2*Math.PI),MOUSE.move.angle.x>=Math.PI/2?MOUSE.move.angle.x=Math.PI/2-MOUSE.move.x:MOUSE.move.angle.x<=-Math.PI/2&&(MOUSE.move.angle.x=-Math.PI/2+MOUSE.move.x),MOUSE.down.x=a.pageX,MOUSE.down.y=a.pageY,a.preventDefault()}}function zoom_plus(){var a=MOUSE.wheel.reduction>1?MOUSE.wheel.reduction:1;MOUSE.wheel.deltaMax=(SETTINGS.mode.fisheye.video.radius-2*MOUSE.wheel.sensitivity)/a,MOUSE.wheel.deltaMin=-MOUSE.wheel.deltaMax,Math.abs(MOUSE.wheel.delta)<MOUSE.wheel.deltaMax?MOUSE.wheel.delta+=MOUSE.wheel.sensitivity:MOUSE.wheel.delta>0?MOUSE.wheel.delta-=MOUSE.wheel.sensitivity:MOUSE.wheel.delta+=MOUSE.wheel.sensitivity}function zoom_minus(){var a=MOUSE.wheel.reduction>1?MOUSE.wheel.reduction:1;MOUSE.wheel.deltaMax=(SETTINGS.mode.fisheye.video.radius-2*MOUSE.wheel.sensitivity)/a,MOUSE.wheel.deltaMin=-MOUSE.wheel.deltaMax,Math.abs(MOUSE.wheel.delta)<MOUSE.wheel.deltaMax?MOUSE.wheel.delta-=MOUSE.wheel.sensitivity:MOUSE.wheel.delta>0?MOUSE.wheel.delta-=MOUSE.wheel.sensitivity:MOUSE.wheel.delta+=MOUSE.wheel.sensitivity}function onDocumentKeyPress(a){if(KEYBOARD.active){(SETTINGS.mode.fisheye.video.active||SETTINGS.mode.equirectangular.video.active)&&(113!=a.keyCode&&81!=a.keyCode||(log("video: play"),SETTINGS.input.video.play()),101!=a.keyCode&&69!=a.keyCode||(log("video: pause"),SETTINGS.input.video.pause()),0!==a.keyCode&&32!==a.keyCode||(1==SETTINGS.input.video.paused?(log("video: play"),SETTINGS.input.video.play(),SETTINGS.video_controlls.object.btn.play.setAttribute("class","pause_icon")):(log("video: pause"),SETTINGS.input.video.pause(),SETTINGS.video_controlls.object.btn.play.setAttribute("class","play_icon")))),97==a.keyCode||65==a.keyCode?MOUSE.move.angle.y+=KEYBOARD.sensitivity.x:100==a.keyCode||68==a.keyCode?MOUSE.move.angle.y-=KEYBOARD.sensitivity.x:119==a.keyCode||87==a.keyCode?MOUSE.move.angle.x-=KEYBOARD.sensitivity.y:115!=a.keyCode&&83!=a.keyCode||(MOUSE.move.angle.x+=KEYBOARD.sensitivity.y);MOUSE.wheel.reduction>1&&MOUSE.wheel.reduction;43==a.keyCode&&zoom_plus(),45==a.keyCode&&zoom_minus()}}function setFishVideoMode(){SETTINGS.mode.fisheye.video.active=!0,SETTINGS.mode.fisheye.panorama.active=!1,SETTINGS.mode.equirectangular.panorama.active=!1,SETTINGS.mode.equirectangular.video.active=!1}function setEquiVideoMode(){SETTINGS.mode.fisheye.video.active=!1,SETTINGS.mode.fisheye.panorama.active=!1,SETTINGS.mode.equirectangular.panorama.active=!1,SETTINGS.mode.equirectangular.video.active=!0}function setFishPanoMode(){SETTINGS.mode.fisheye.video.active=!1,SETTINGS.mode.fisheye.panorama.active=!0,SETTINGS.mode.equirectangular.panorama.active=!1,SETTINGS.mode.equirectangular.video.active=!1}function setEquiPanoMode(){SETTINGS.mode.fisheye.video.active=!1,SETTINGS.mode.fisheye.panorama.active=!1,SETTINGS.mode.equirectangular.panorama.active=!0,SETTINGS.mode.equirectangular.video.active=!1}function onWindowResize(a){var b=document.querySelector("canvas");b&&(window.innerWidth<b.width||window.innerHeight<b.height||window.innerWidth>=b.width&&SETTINGS.default.canvas.resize)&&(b.width=window.innerWidth,b.height=window.innerHeight,gl.viewport(0,0,b.width,b.height),resize(),SETTINGS.default.canvas.resize=!0)}function resize(){updateObjectVariables()}function main(){return PROG.fatal_error?(e("Doslo k chybe... PROGRAM se ukonci "),!1):!!initProgram()&&(!!setupProgram()&&(render(0),void SETTINGS.input.video.addEventListener("loadedmetadata",function(){this.currentTime=getParamByKey("time")?getParamByKey("time"):0},!1)))}var gl,GEOMETRY,MOUSE={down:{x:0,y:0},move:{x:0,y:0,angle:{x:0,y:0}},wheel:{sensitivity:.15,reduction:1.3,delta:0,deltaMax:0,deltaMin:0},active:!1,interrupt:!1,amort:0},KEYBOARD={active:!0,sensitivity:{x:.06,y:.06}},SETTINGS={mode:{equirectangular:{panorama:{active:!0},video:{active:!1}},fisheye:{panorama:{active:!1},video:{active:!1,latitudes:60,longtitudes:60,radius:7}}},default:{canvas:{width:null,height:null,resize:null}},input:{video:null,image:null},field_vision:{width:200,height:200,canvas_position_x:.85,canvas_position_y:1,object:null,angle:0,shift:0},compass:{width:180,height:180,canvas_position_x:.6,canvas_position_y:1,north:20,angle:0,object:null},video_controlls:{created:null,user_inactive:!1,object:null,width:null,height:75,canvas_position_x:0,canvas_position_y:1},video_status_bar:{object:null,width:170,height:20,canvas_position_x:1,canvas_position_y:0},panorama_controlls:{object:null,width:260,height:50,canvas_position_x:1,canvas_position_y:1,btn:{settings:{object:null,show_window:!1,width:150,height:300,canvas_position_x:1,canvas_position_y:.2}},subtitles_box:{object:null,width:250,height:50,canvas_position_x:.2,canvas_position_y:.85,active:!1,current_subtitle:"..."}},info_screen:{width:300,height:150}},PROG={shader:{equirectangular:{panorama:null,video:null}},buffer:{normal:null,index:null,vertex:null,texture:null},attributes:{vertex:null,fragment:null,texture:null},matrices:{model:{link:null,data:null},view:{link:null,data:null},projection:{link:null,data:null,fov:null}},texture:null,sampler:null,program:null,canvas:null,time:null,startTime:null,fatal_error:!1},CACHE={json_object:null};getParamByKey("video")&&(SETTINGS.input.video=createVideo(getParamByKey("video"))),setFishVideoMode(),getParamByKey("fishVM")&&setFishVideoMode(),getParamByKey("equiVM")&&setEquiVideoMode(),getParamByKey("fishPM")&&setFishPanoMode(),getParamByKey("equiPM")&&setEquiPanoMode();var JSON=loadJSONfile();!1===JSON&&(PROG.fatal_error=!0),SETTINGS.mode.fisheye.video.active||SETTINGS.mode.equirectangular.video.active?JSON&&JSON.video&&JSON.video?SETTINGS.input.video=createVideo(JSON.video):w("v souboru JSON neni video, nebo jeho zdroj"):(SETTINGS.mode.fisheye.panorama.active||SETTINGS.mode.equirectangular.panorama.active)&&(JSON&&JSON.image&&JSON.image?SETTINGS.input.image=createImage(JSON.image):w("v souboru JSON neni obrazek, nebo jeho zdroj"));